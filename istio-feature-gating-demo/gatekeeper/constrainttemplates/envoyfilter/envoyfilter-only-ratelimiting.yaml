apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  annotations:
    description: Verify that only rate limiting EnvoyFilters are used. 
  name: onlyratelimitingenvoyfilter
spec:
  crd:
    spec:
      names:
        kind: OnlyRateLimitingEnvoyFilter
      validation:
        openAPIV3Schema:
          type: object
          properties:
            rateLimitGlobalEnvoyFilterType:
              description: String for the EnvoyFilter rate limit type. 
              type: string
  targets:
  - target: admission.k8s.gatekeeper.sh
    rego: |-
      package istio.networking.envoyfilter

      spec = input.review.object.spec

      violation[{"msg": msg}] {
        is_envoyfilter(input.review.kind)
        filterType := spec.configPatches[_].patch.value.typed_config["@type"]
        filterType != ""
        filterType != input.parameters.rateLimitGlobalEnvoyFilterType
        msg := sprintf("Cannot use EnvoyFilter of filter type: %v, only allowed type is %v", [filterType, input.parameters.rateLimitGlobalEnvoyFilterType])
      }

      is_envoyfilter(kind) {
          kind.kind == "EnvoyFilter"
          kind.group == "networking.istio.io"
      }
