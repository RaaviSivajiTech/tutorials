parameters:
  - name: image_registry
    type: string
  - name: image_name
    type: string
  - name: image_tag
    type: string
    default: latest
  - name: dockerfile_path
    type: string

steps:
  - bash: |
      docker build -t ${{ parameters.image_registry }}/${{ parameters.image_name }}:${{ parameters.image_tag }} .
      docker save -o ${{ parameters.image_name }}.tar ${{ parameters.image_registry }}/${{ parameters.image_name }}:${{ parameters.image_tag }}
      docker push ${{ parameters.image_registry }}/${{ parameters.image_name }}:${{ parameters.image_tag }}
    displayName: Build and push docker image ${{ parameters.image_name }} to ${{ parameters.image_registry }}
    workingDirectory: ${{ parameters.dockerfile_path }}